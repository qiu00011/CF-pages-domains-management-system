
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CF Pages Hub - ç»¼åˆç®¡ç†é¢æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; overflow: hidden; }
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dark .glass {
            background: rgba(30, 30, 30, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #custom-bg-layer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -10;
            object-fit: cover;
            transition: opacity 1.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease forwards; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body class="bg-slate-50 text-slate-900 transition-colors duration-500">
    <div id="root"></div>

    <script type="module">
        import { h, Component, render } from 'https://esm.sh/preact';
        import { useState, useEffect, useCallback, useMemo } from 'https://esm.sh/preact/hooks';
        import htm from 'https://esm.sh/htm';

        // åˆå§‹åŒ– htm
        const html = htm.bind(h);

        // --- å­ç»„ä»¶: Login ---
        const Login = ({ onLoginSuccess }) => {
            const [password, setPassword] = useState('');
            const [error, setError] = useState(false);
            const [loading, setLoading] = useState(false);

            const handleLogin = async () => {
                setLoading(true); setError(false);
                try {
                    const resp = await fetch('/api/auth', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });
                    const data = await resp.json();
                    if (data.success) {
                        sessionStorage.setItem('authenticated', 'true');
                        onLoginSuccess();
                    } else { setError(true); }
                } catch (e) { setError(true); } finally { setLoading(false); }
            };

            return html`
                <div class="h-screen w-screen flex items-center justify-center bg-slate-900 overflow-hidden relative">
                    <div class="absolute inset-0 bg-gradient-to-tr from-indigo-900 via-slate-900 to-emerald-900 opacity-50"></div>
                    <div class="relative glass w-full max-w-sm p-10 rounded-[40px] shadow-2xl text-center space-y-8 animate-fade-in border-white/10">
                        <div class="w-20 h-20 bg-blue-600 mx-auto rounded-3xl flex items-center justify-center text-white text-3xl font-black shadow-xl rotate-3">CF</div>
                        <div class="space-y-2">
                            <h2 class="text-3xl font-bold text-white">èº«ä»½è®¤è¯</h2>
                            <p class="text-slate-400 text-sm">Cloudflare Pages ç©ºé—´ç«™</p>
                        </div>
                        <div class="space-y-4">
                            <input type="password" class="w-full bg-black/40 border ${error ? 'border-red-500' : 'border-white/10'} rounded-2xl px-5 py-4 text-center outline-none focus:ring-2 ring-blue-500 transition-all text-white" 
                                placeholder="è¾“å…¥è®¿é—®å¯†ç " value=${password} onInput=${e => setPassword(e.target.value)} onKeyDown=${e => e.key === 'Enter' && handleLogin()} />
                            <button onClick=${handleLogin} disabled=${loading} class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-500/20 active:scale-95 transition-all">
                                ${loading ? 'æ­£åœ¨è¿›å…¥...' : 'ç«‹å³è¿›å…¥ç³»ç»Ÿ'}
                            </button>
                            ${error && html`<p class="text-red-500 text-xs font-semibold animate-pulse">å¯†ç éªŒè¯å¤±è´¥ï¼Œè¯·é‡è¯•</p>`}
                        </div>
                    </div>
                </div>
            `;
        };

        // --- å­ç»„ä»¶: DomainManager ---
        const DomainManager = ({ config }) => {
            const [projects, setProjects] = useState([]);
            const [selectedProject, setSelectedProject] = useState('');
            const [domains, setDomains] = useState([]);
            const [newDomain, setNewDomain] = useState('');
            const [loading, setLoading] = useState(false);
            const [logs, setLogs] = useState([]);

            const addLog = (msg) => setLogs(prev => [...prev.slice(-20), `[${new Date().toLocaleTimeString()}] ${msg}`]);

            const fetchData = async (url, options = {}) => {
                const headers = { 
                    'X-Pages-Token': config.pagesToken, 
                    'X-Zone-Token': config.zoneToken, 
                    'X-Account-Id': config.accountId,
                    ...options.headers 
                };
                return fetch(url, { ...options, headers });
            };

            const fetchProjects = async () => {
                if (!config.accountId || !config.pagesToken) return;
                setLoading(true); addLog("è·å–é¡¹ç›®åˆ—è¡¨ä¸­...");
                try {
                    const resp = await fetchData(`/api/cf/accounts/${config.accountId}/pages/projects`);
                    const data = await resp.json();
                    if (data.success) {
                        setProjects(data.result);
                        if (data.result.length > 0 && !selectedProject) setSelectedProject(data.result[0].name);
                    }
                } catch (err) { addLog(`é”™è¯¯: ${err}`); } finally { setLoading(false); }
            };

            const fetchDomains = async (projName) => {
                if (!projName) return;
                setLoading(true);
                try {
                    const resp = await fetchData(`/api/cf/accounts/${config.accountId}/pages/projects/${projName}/domains`);
                    const data = await resp.json();
                    if (data.success) setDomains(data.result);
                } catch (err) { addLog(`è·å–åŸŸåå¤±è´¥: ${err}`); } finally { setLoading(false); }
            };

            const handleAction = async (action, domainName = '') => {
                setLoading(true);
                try {
                    const url = `/api/cf/accounts/${config.accountId}/pages/projects/${selectedProject}/domains${domainName ? '/' + domainName : ''}`;
                    const resp = await fetchData(url, {
                        method: action === 'add' ? 'POST' : 'DELETE',
                        body: action === 'add' ? JSON.stringify({ name: newDomain }) : undefined
                    });
                    const data = await resp.json();
                    if (data.success) {
                        addLog(`${action === 'add' ? 'æ·»åŠ ' : 'ç§»é™¤'}æˆåŠŸ`);
                        if (action === 'add') setNewDomain('');
                        fetchDomains(selectedProject);
                    } else { addLog(`å¤±è´¥: ${JSON.stringify(data.errors)}`); }
                } catch (err) { addLog(`å¼‚å¸¸: ${err}`); } finally { setLoading(false); }
            };

            useEffect(() => { fetchProjects(); }, [config.accountId]);
            useEffect(() => { if (selectedProject) fetchDomains(selectedProject); }, [selectedProject]);

            return html`
                <div class="space-y-6 animate-fade-in">
                    <div class="flex justify-between items-end">
                        <div>
                            <h2 class="text-2xl font-bold dark:text-white">åŸŸåç®¡ç†é¢æ¿</h2>
                            <p class="text-slate-500 text-sm">é…ç½®é¡¹ç›®è‡ªå®šä¹‰åŸŸåä¸ DNS</p>
                        </div>
                        <button onClick=${fetchProjects} class="px-4 py-2 bg-white/50 dark:bg-white/10 rounded-lg text-sm hover:bg-white transition-colors dark:text-white">åˆ·æ–°æ•°æ®</button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div class="p-5 bg-white/40 dark:bg-white/5 rounded-2xl border border-white/20">
                                <label class="block text-xs font-semibold text-slate-500 uppercase mb-2">é€‰æ‹© Pages é¡¹ç›®</label>
                                <select class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-3 outline-none dark:text-white text-sm"
                                    value=${selectedProject} onChange=${e => setSelectedProject(e.target.value)}>
                                    ${projects.map(p => html`<option value=${p.name}>${p.name}</option>`)}
                                </select>
                            </div>
                            <div class="p-5 bg-white/40 dark:bg-white/5 rounded-2xl border border-white/20">
                                <label class="block text-xs font-semibold text-slate-500 uppercase mb-2">å¿«é€Ÿç»‘å®šæ–°åŸŸå</label>
                                <div class="flex gap-2">
                                    <input class="flex-1 bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-3 outline-none dark:text-white text-sm" 
                                        placeholder="sub.domain.com" value=${newDomain} onInput=${e => setNewDomain(e.target.value)} />
                                    <button onClick=${() => handleAction('add')} disabled=${loading || !newDomain} class="bg-blue-600 text-white px-6 rounded-xl font-medium hover:bg-blue-700 disabled:opacity-50">æ·»åŠ </button>
                                </div>
                            </div>
                        </div>

                        <div class="p-5 bg-white/40 dark:bg-white/5 rounded-2xl border border-white/20 flex flex-col min-h-[200px]">
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-3">å½“å‰å·²ç»‘å®š</label>
                            <div class="flex-1 overflow-y-auto space-y-2 pr-2">
                                ${domains.length === 0 ? html`<div class="h-full flex items-center justify-center opacity-30 italic text-sm dark:text-white">æš‚æ— åŸŸå</div>` : 
                                  domains.map(d => html`
                                    <div class="flex items-center justify-between p-3 bg-white dark:bg-slate-900/50 rounded-xl border border-slate-100 dark:border-white/5">
                                        <span class="text-sm dark:text-white font-medium">${d.name}</span>
                                        <button onClick=${() => handleAction('remove', d.name)} class="text-red-500 text-xs hover:bg-red-50 p-2 rounded-lg">ç§»é™¤</button>
                                    </div>
                                `)}
                            </div>
                        </div>
                    </div>

                    <div class="bg-slate-900 text-emerald-400 p-4 rounded-2xl font-mono text-[10px] h-24 overflow-y-auto border border-white/5 shadow-inner">
                        ${logs.map(log => html`<div>${log}</div>`)}
                    </div>
                </div>
            `;
        };

        // --- å­ç»„ä»¶: SubdomainGenerator ---
        const SubdomainGenerator = ({ config }) => {
            const [dateStr, setDateStr] = useState('');
            const [results, setResults] = useState([]);

            const handleGenerate = () => {
                const parts = dateStr.split(".");
                if (parts.length !== 2) { alert("æ ¼å¼é”™è¯¯ (MM.DD)"); return; }
                const randomL = (n) => Array.from({length:n}, () => "abcdefghijklmnopqrstuvwxyz"[Math.floor(Math.random()*26)]).join('');
                const prefix = randomL(2) + parts[0].padStart(2, '0') + randomL(2) + parts[1].padStart(2, '0') + randomL(2);
                const domain = `${prefix}.${config.parentDomain || 'example.com'}`;
                
                const res = [{ label: 'å­åŸŸå', value: domain }];
                (config.paths || []).forEach(p => res.push({ label: `URL (${p.label})`, value: `https://${domain}/${p.value}` }));
                setResults(res);
            };

            return html`
                <div class="max-w-xl mx-auto py-4 space-y-8 animate-fade-in">
                    <div class="text-center space-y-2">
                        <h2 class="text-3xl font-bold dark:text-white">éšæœºç”Ÿæˆå™¨</h2>
                        <p class="text-slate-500">åŸºäºæ—¥æœŸé€»è¾‘ç”Ÿæˆé«˜å¼ºåº¦å”¯ä¸€å­åŸŸå</p>
                    </div>
                    <div class="bg-white/40 dark:bg-white/5 p-8 rounded-3xl border border-white/20 shadow-xl space-y-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold dark:text-slate-300">è¾“å…¥æ—¥æœŸ (MM.DD)</label>
                            <div class="flex gap-3">
                                <input class="flex-1 bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/10 rounded-2xl px-5 py-4 outline-none text-lg font-mono dark:text-white" 
                                    placeholder="ä¾‹å¦‚ 12.25" value=${dateStr} onInput=${e => setDateStr(e.target.value)} />
                                <button onClick=${handleGenerate} class="bg-blue-600 text-white px-8 rounded-2xl font-bold">ç”Ÿæˆ</button>
                            </div>
                        </div>
                        ${results.length > 0 && html`
                            <div class="space-y-3 pt-4">
                                ${results.map(r => html`
                                    <div class="p-4 bg-white dark:bg-slate-900 border border-slate-100 dark:border-white/5 rounded-2xl flex items-center justify-between">
                                        <div class="overflow-hidden">
                                            <div class="text-[10px] font-bold text-slate-400 uppercase">${r.label}</div>
                                            <div class="text-sm font-mono truncate dark:text-slate-200">${r.value}</div>
                                        </div>
                                        <button onClick=${() => {navigator.clipboard.writeText(r.value); alert('å·²å¤åˆ¶')}} class="text-xs text-blue-500 font-bold ml-4">å¤åˆ¶</button>
                                    </div>
                                `)}
                            </div>
                        `}
                    </div>
                </div>
            `;
        };

        // --- å­ç»„ä»¶: Settings ---
        const Settings = ({ config, setConfig }) => {
            const [local, setLocal] = useState({ ...config });
            const [saving, setSaving] = useState(false);

            const handleSave = async () => {
                setSaving(true);
                try {
                    const resp = await fetch('/api/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(local)
                    });
                    if ((await resp.json()).success) { setConfig(local); alert("é…ç½®å·²ä¿å­˜"); }
                } catch (e) { alert("å¤±è´¥: " + e); } finally { setSaving(false); }
            };

            return html`
                <div class="space-y-8 pb-10 animate-fade-in">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold dark:text-white">ç³»ç»Ÿè®¾ç½®</h2>
                        <button onClick=${handleSave} class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg">${saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜é…ç½®'}</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="p-6 bg-white/40 dark:bg-white/5 rounded-3xl border border-white/20 space-y-4">
                            <h3 class="text-xs font-bold text-slate-400 uppercase">Cloudflare å‡­æ®</h3>
                            <input class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-3 outline-none dark:text-white text-sm" 
                                placeholder="Account ID" value=${local.accountId} onInput=${e => setLocal({...local, accountId: e.target.value})} />
                            <input type="password" class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-3 outline-none dark:text-white text-sm" 
                                placeholder="Pages API Token" value=${local.pagesToken} onInput=${e => setLocal({...local, pagesToken: e.target.value})} />
                        </div>
                        <div class="p-6 bg-white/40 dark:bg-white/5 rounded-3xl border border-white/20 space-y-4">
                            <h3 class="text-xs font-bold text-slate-400 uppercase">ç”Ÿæˆå™¨é…ç½®</h3>
                            <input class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-3 outline-none dark:text-white text-sm" 
                                placeholder="çˆ¶åŸŸå (example.com)" value=${local.parentDomain} onInput=${e => setLocal({...local, parentDomain: e.target.value})} />
                            <input class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-3 outline-none dark:text-white text-sm" 
                                placeholder="èƒŒæ™¯å›¾ç‰‡/è§†é¢‘ URL" value=${local.backgroundUrl} onInput=${e => setLocal({...local, backgroundUrl: e.target.value})} />
                        </div>
                    </div>
                </div>
            `;
        };

        // --- ä¸»ç¨‹åº: App ---
        const App = () => {
            const [auth, setAuth] = useState(sessionStorage.getItem('authenticated') === 'true');
            const [tab, setTab] = useState('domains');
            const [isDark, setIsDark] = useState(false);
            const [config, setConfig] = useState({ accountId: '', pagesToken: '', zoneToken: '', backgroundUrl: '', parentDomain: '', paths: [{label:'U1', value:'uuid'}] });

            useEffect(() => {
                if (auth) {
                    fetch('/api/config').then(r => r.json()).then(d => d.success && d.config && setConfig(d.config));
                }
            }, [auth]);

            useEffect(() => {
                document.documentElement.classList.toggle('dark', isDark);
                const bg = document.getElementById('custom-bg-layer');
                if (bg) bg.remove();
                if (config.backgroundUrl) {
                    const isVid = /\.(mp4|webm|mov)/i.test(config.backgroundUrl);
                    const el = document.createElement(isVid ? 'video' : 'img');
                    el.id = 'custom-bg-layer'; el.src = config.backgroundUrl; el.style.opacity = '0';
                    if (isVid) { el.autoplay = el.loop = el.muted = el.playsInline = true; }
                    document.body.appendChild(el); setTimeout(() => el.style.opacity = '1', 50);
                }
            }, [isDark, config.backgroundUrl]);

            if (!auth) return html`<${Login} onLoginSuccess=${() => setAuth(true)} />`;

            return html`
                <div class="flex h-screen w-screen overflow-hidden relative z-10 p-4">
                    <!-- Sidebar -->
                    <div class="w-64 glass rounded-3xl p-6 flex flex-col shadow-xl mr-4">
                        <div class="flex items-center gap-3 mb-10">
                            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white text-xl font-bold">CF</div>
                            <h1 class="font-semibold text-lg dark:text-white">Pages Hub</h1>
                        </div>
                        <nav class="flex-1 space-y-2">
                            ${['domains', 'generator', 'settings'].map(t => html`
                                <button onClick=${() => setTab(t)} class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${tab === t ? 'bg-blue-600 text-white shadow-md' : 'text-slate-600 dark:text-slate-300 hover:bg-white/50 dark:hover:bg-white/5'}">
                                    <span class="font-medium">${t === 'domains' ? 'åŸŸåç®¡ç†' : t === 'generator' ? 'éšæœºç”Ÿæˆ' : 'ç³»ç»Ÿè®¾ç½®'}</span>
                                </button>
                            `)}
                        </nav>
                        <button onClick=${() => setIsDark(!isDark)} class="mt-auto p-3 rounded-full bg-slate-100 dark:bg-slate-800 self-start hover:scale-110 transition-transform">
                            ${isDark ? 'ğŸŒ™' : 'â˜€ï¸'}
                        </button>
                    </div>
                    
                    <!-- Main -->
                    <main class="flex-1 overflow-y-auto p-8 glass rounded-3xl shadow-2xl relative">
                        ${tab === 'domains' && html`<${DomainManager} config=${config} />`}
                        ${tab === 'generator' && html`<${SubdomainGenerator} config=${config} />`}
                        ${tab === 'settings' && html`<${Settings} config=${config} setConfig=${setConfig} />`}
                    </main>

                    ${!config.backgroundUrl && html`<div class="fixed inset-0 -z-20 bg-gradient-to-br from-indigo-50 via-white to-sky-50 dark:from-slate-950 dark:via-slate-900 dark:to-slate-950"></div>`}
                </div>
            `;
        };

        render(html`<${App} />`, document.getElementById('root'));
    </script>
</body>
</html>
