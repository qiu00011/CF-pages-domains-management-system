<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­æ€¡vpné¢æ¿ - ç»¼åˆç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; overflow: hidden; }
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dark .glass {
            background: rgba(30, 30, 30, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #custom-bg-layer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -10;
            object-fit: cover;
            transition: opacity 1.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease forwards; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body class="bg-slate-50 text-slate-900 transition-colors duration-500">
    <div id="root"></div>

    <script type="module">
        import { h, Component, render } from 'https://esm.sh/preact';
        import { useState, useEffect, useCallback, useMemo } from 'https://esm.sh/preact/hooks';
        import htm from 'https://esm.sh/htm';

        const html = htm.bind(h);

        const APP_LOGO = "https://image.hyeri.us.kg/icon.png";
        const APP_NAME = "å­æ€¡vpné¢æ¿";

        // --- å­ç»„ä»¶: Login ---
        const Login = ({ onLoginSuccess }) => {
            const [password, setPassword] = useState('');
            const [error, setError] = useState(false);
            const [loading, setLoading] = useState(false);

            const handleLogin = async () => {
                setLoading(true); setError(false);
                try {
                    const resp = await fetch('/api/auth', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });
                    const data = await resp.json();
                    if (data.success) {
                        sessionStorage.setItem('authenticated', 'true');
                        onLoginSuccess();
                    } else { setError(true); }
                } catch (e) { setError(true); } finally { setLoading(false); }
            };

            return html`
                <div class="h-screen w-screen flex items-center justify-center bg-slate-900 overflow-hidden relative">
                    <div class="absolute inset-0 bg-gradient-to-tr from-indigo-900 via-slate-900 to-emerald-900 opacity-50"></div>
                    <div class="relative glass w-full max-sm:mx-4 max-w-sm p-10 rounded-[40px] shadow-2xl text-center space-y-8 animate-fade-in border-white/10">
                        <img src="${APP_LOGO}" class="w-20 h-20 mx-auto rounded-3xl shadow-xl rotate-3 object-cover" />
                        <div class="space-y-2">
                            <h2 class="text-3xl font-bold text-white">${APP_NAME}</h2>
                            <p class="text-slate-400 text-sm">äº‘ç«¯ Pages è°ƒåº¦ç³»ç»Ÿ</p>
                        </div>
                        <div class="space-y-4">
                            <input type="password" class="w-full bg-black/40 border ${error ? 'border-red-500' : 'border-white/10'} rounded-2xl px-5 py-4 text-center outline-none focus:ring-2 ring-blue-500 transition-all text-white" 
                                placeholder="è¾“å…¥è®¿é—®å¯†ç " value=${password} onInput=${e => setPassword(e.target.value)} onKeyDown=${e => e.key === 'Enter' && handleLogin()} />
                            <button onClick=${handleLogin} disabled=${loading} class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-500/20 active:scale-95 transition-all">
                                ${loading ? 'æ­£åœ¨è¿›å…¥...' : 'ç«‹å³è¿›å…¥ç³»ç»Ÿ'}
                            </button>
                            ${error && html`<p class="text-red-500 text-xs font-semibold animate-pulse">éªŒè¯å¤±è´¥</p>`}
                        </div>
                    </div>
                </div>
            `;
        };

        // --- å­ç»„ä»¶: DomainManager ---
        const DomainManager = ({ config }) => {
            const [projects, setProjects] = useState([]);
            const [selectedProject, setSelectedProject] = useState('');
            const [domains, setDomains] = useState([]);
            const [newDomain, setNewDomain] = useState('');
            const [loading, setLoading] = useState(false);
            const [logs, setLogs] = useState([]);

            const addLog = (msg) => setLogs(prev => [...prev.slice(-20), `[${new Date().toLocaleTimeString()}] ${msg}`]);

            const fetchData = async (url, options = {}) => {
                const headers = { 
                    'X-Pages-Token': config.pagesToken, 
                    'X-Zone-Token': config.zoneToken, 
                    'X-Account-Id': config.accountId,
                    ...options.headers 
                };
                return fetch(url, { ...options, headers });
            };

            const fetchProjects = async () => {
                if (!config.accountId || !config.pagesToken) {
                    addLog("âš ï¸ è¯·å…ˆé…ç½® API å‡­æ®");
                    return;
                }
                setLoading(true); addLog("è·å–é¡¹ç›®åˆ—è¡¨ä¸­...");
                try {
                    const resp = await fetchData(`/api/cf/accounts/${config.accountId}/pages/projects`);
                    const data = await resp.json();
                    if (data.success) {
                        setProjects(data.result);
                        if (data.result.length > 0 && !selectedProject) setSelectedProject(data.result[0].name);
                    } else {
                        addLog(`è·å–å¤±è´¥: ${data.errors?.[0]?.message || 'é”™è¯¯'}`);
                    }
                } catch (err) { addLog(`ç½‘ç»œé”™è¯¯: ${err}`); } finally { setLoading(false); }
            };

            const fetchDomains = async (projName) => {
                if (!projName) return;
                setLoading(true);
                try {
                    const resp = await fetchData(`/api/cf/accounts/${config.accountId}/pages/projects/${projName}/domains`);
                    const data = await resp.json();
                    if (data.success) setDomains(data.result);
                } catch (err) { addLog(`è·å–åŸŸåå¤±è´¥: ${err}`); } finally { setLoading(false); }
            };

            const handleAction = async (action, domainName = '') => {
                const targetDomain = action === 'add' ? newDomain : domainName;
                if (!targetDomain || !selectedProject) return;
                setLoading(true);
                try {
                    const url = `/api/cf/accounts/${config.accountId}/pages/projects/${selectedProject}/domains${domainName ? '/' + domainName : ''}`;
                    const resp = await fetchData(url, {
                        method: action === 'add' ? 'POST' : 'DELETE',
                        body: action === 'add' ? JSON.stringify({ name: targetDomain }) : undefined
                    });
                    const data = await resp.json();
                    if (data.success) {
                        addLog(`âœ… æˆåŠŸ: ${targetDomain}`);
                        if (action === 'add') setNewDomain('');
                        fetchDomains(selectedProject);
                    } else { 
                      addLog(`âŒ å¤±è´¥: ${data.errors?.[0]?.message || 'API é”™è¯¯'}`); 
                    }
                } catch (err) { addLog(`âš ï¸ å¼‚å¸¸: ${err}`); } finally { setLoading(false); }
            };

            useEffect(() => { fetchProjects(); }, [config.accountId, config.pagesToken]);
            useEffect(() => { if (selectedProject) fetchDomains(selectedProject); }, [selectedProject]);

            return html`
                <div class="space-y-6 animate-fade-in">
                    <div class="flex justify-between items-end">
                        <div>
                            <h2 class="text-2xl font-bold dark:text-white tracking-tight">åŸŸåç®¡ç†é¢æ¿</h2>
                            <p class="text-slate-500 text-sm">ç®¡ç† Cloudflare Pages è‡ªå®šä¹‰åŸŸå</p>
                        </div>
                        <button onClick=${fetchProjects} class="px-4 py-2 bg-white/50 dark:bg-white/10 rounded-lg text-sm hover:bg-white transition-colors dark:text-white border border-white/20">åˆ·æ–°æ•°æ®</button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div class="p-5 bg-white/40 dark:bg-white/5 rounded-2xl border border-white/20">
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">é€‰æ‹©é¡¹ç›®</label>
                                <select class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-3 outline-none dark:text-white text-sm"
                                    value=${selectedProject} onChange=${e => setSelectedProject(e.target.value)}>
                                    ${projects.length === 0 ? html`<option>æš‚æ— é¡¹ç›®</option>` : projects.map(p => html`<option value=${p.name}>${p.name}</option>`)}
                                </select>
                            </div>
                            <div class="p-5 bg-white/40 dark:bg-white/5 rounded-2xl border border-white/20">
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">å¿«é€Ÿç»‘å®š</label>
                                <div class="flex gap-2">
                                    <input class="flex-1 bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/10 rounded-xl px-4 py-3 outline-none dark:text-white text-sm" 
                                        placeholder="sub.domain.com" value=${newDomain} onInput=${e => setNewDomain(e.target.value)} />
                                    <button onClick=${() => handleAction('add')} disabled=${loading || !newDomain} class="bg-blue-600 text-white px-6 rounded-xl font-medium hover:bg-blue-700 disabled:opacity-50 transition-all">æ·»åŠ </button>
                                </div>
                            </div>
                        </div>

                        <div class="p-5 bg-white/40 dark:bg-white/5 rounded-2xl border border-white/20 flex flex-col min-h-[220px]">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-3">å½“å‰åŸŸååˆ—è¡¨</label>
                            <div class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scroll">
                                ${domains.length === 0 ? html`<div class="h-full flex items-center justify-center opacity-30 italic text-sm dark:text-white">ç©º</div>` : 
                                  domains.map(d => html`
                                    <div class="flex items-center justify-between p-3 bg-white dark:bg-slate-900/50 rounded-xl border border-slate-100 dark:border-white/5">
                                      <div>
                                        <div class="text-sm dark:text-white font-medium">${d.name}</div>
                                        <div class="text-[10px] text-slate-400 uppercase font-bold">${d.status}</div>
                                      </div>
                                      <button onClick=${() => handleAction('remove', d.name)} class="text-red-500 text-xs hover:bg-red-50 px-3 py-2 rounded-lg font-bold">ç§»é™¤</button>
                                    </div>
                                `)}
                            </div>
                        </div>
                    </div>

                    <div class="bg-slate-900 text-emerald-400 p-4 rounded-2xl font-mono text-[10px] h-32 overflow-y-auto border border-white/5 shadow-inner">
                        ${logs.map(log => html`<div>${log}</div>`)}
                    </div>
                </div>
            `;
        };

        // --- å­ç»„ä»¶: SubdomainGenerator ---
        const SubdomainGenerator = ({ config }) => {
            const [dateStr, setDateStr] = useState('');
            const [results, setResults] = useState([]);

            const handleGenerate = () => {
                const parts = dateStr.split(".");
                if (parts.length !== 2) { alert("æ ¼å¼: MM.DD"); return; }
                const randomL = (n) => Array.from({length:n}, () => "abcdefghijklmnopqrstuvwxyz"[Math.floor(Math.random()*26)]).join('');
                const prefix = randomL(2) + parts[0].padStart(2, '0') + randomL(2) + parts[1].padStart(2, '0') + randomL(2);
                const domain = `${prefix}.${config.parentDomain || 'example.com'}`;
                
                const res = [{ label: 'å­åŸŸå', value: domain }];
                (config.paths || []).forEach(p => res.push({ label: `URL (${p.label})`, value: `https://${domain}/${p.value}` }));
                setResults(res);
            };

            return html`
                <div class="max-w-xl mx-auto py-4 space-y-8 animate-fade-in">
                    <div class="text-center space-y-2">
                        <h2 class="text-3xl font-bold dark:text-white">éšæœºå­åŸŸåç³»ç»Ÿ</h2>
                        <p class="text-slate-500">åŸºäºç‰¹å®šæ—¥æœŸé€»è¾‘ç”Ÿæˆå”¯ä¸€è®¿é—®åœ°å€</p>
                    </div>
                    <div class="bg-white/40 dark:bg-white/5 p-8 rounded-3xl border border-white/20 shadow-xl space-y-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-bold dark:text-slate-300">æ—¥æœŸ (MM.DD)</label>
                            <div class="flex gap-3">
                                <input class="flex-1 bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/10 rounded-2xl px-5 py-4 outline-none text-lg font-mono dark:text-white" 
                                    placeholder="12.31" value=${dateStr} onInput=${e => setDateStr(e.target.value)} />
                                <button onClick=${handleGenerate} class="bg-blue-600 text-white px-8 rounded-2xl font-bold shadow-lg">ç”Ÿæˆ</button>
                            </div>
                        </div>
                        ${results.length > 0 && html`
                            <div class="space-y-3 pt-4 border-t border-slate-100 dark:border-white/10">
                                ${results.map(r => html`
                                    <div class="p-4 bg-white dark:bg-slate-900 border border-slate-100 dark:border-white/5 rounded-2xl flex items-center justify-between group">
                                        <div class="overflow-hidden">
                                            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${r.label}</div>
                                            <div class="text-sm font-mono truncate dark:text-slate-200">${r.value}</div>
                                        </div>
                                        <button onClick=${() => {navigator.clipboard.writeText(r.value); alert('å¤åˆ¶æˆåŠŸ')}} class="text-xs text-blue-500 font-bold ml-4">å¤åˆ¶</button>
                                    </div>
                                `)}
                            </div>
                        `}
                    </div>
                </div>
            `;
        };

        // --- å­ç»„ä»¶: Settings ---
        const Settings = ({ config, setConfig }) => {
            const [local, setLocal] = useState({ ...config });
            const [saving, setSaving] = useState(false);

            const handleSave = async () => {
                setSaving(true);
                try {
                    const resp = await fetch('/api/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(local)
                    });
                    if ((await resp.json()).success) { setConfig(local); alert("âœ… å·²ä¿å­˜"); }
                } catch (e) { alert("âŒ å¤±è´¥: " + e); } finally { setSaving(false); }
            };

            const updatePath = (idx, f, v) => {
                const p = [...local.paths]; p[idx][f] = v; setLocal({...local, paths: p});
            };

            return html`
                <div class="space-y-8 pb-10 animate-fade-in">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold dark:text-white tracking-tight">ç³»ç»Ÿç¯å¢ƒè®¾ç½®</h2>
                        <button onClick=${handleSave} class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg">
                          ${saving ? 'æ­£åœ¨åŒæ­¥...' : 'ä¿å­˜é…ç½®'}
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                          <h3 class="text-xs font-black text-slate-400 uppercase flex items-center gap-2">ğŸ”‘ API å‡­æ®</h3>
                          <div class="p-6 bg-white/40 dark:bg-white/5 rounded-[32px] border border-white/20 space-y-4">
                              <input class="w-full bg-white dark:bg-slate-900 border rounded-xl px-4 py-3 dark:text-white text-sm" 
                                  placeholder="Account ID" value=${local.accountId} onInput=${e => setLocal({...local, accountId: e.target.value})} />
                              <input type="password" class="w-full bg-white dark:bg-slate-900 border rounded-xl px-4 py-3 dark:text-white text-sm" 
                                  placeholder="Pages Token" value=${local.pagesToken} onInput=${e => setLocal({...local, pagesToken: e.target.value})} />
                              <input type="password" class="w-full bg-white dark:bg-slate-900 border rounded-xl px-4 py-3 dark:text-white text-sm" 
                                  placeholder="Zone Token" value=${local.zoneToken} onInput=${e => setLocal({...local, zoneToken: e.target.value})} />
                          </div>
                        </div>
                        <div class="space-y-4">
                          <h3 class="text-xs font-black text-slate-400 uppercase flex items-center gap-2">ğŸ¨ ç•Œé¢è®¾ç½®</h3>
                          <div class="p-6 bg-white/40 dark:bg-white/5 rounded-[32px] border border-white/20 space-y-4">
                              <input class="w-full bg-white dark:bg-slate-900 border rounded-xl px-4 py-3 dark:text-white text-sm" 
                                  placeholder="çˆ¶åŸŸå" value=${local.parentDomain} onInput=${e => setLocal({...local, parentDomain: e.target.value})} />
                              <input class="w-full bg-white dark:bg-slate-900 border rounded-xl px-4 py-3 dark:text-white text-sm" 
                                  placeholder="èƒŒæ™¯ç›´é“¾" value=${local.backgroundUrl} onInput=${e => setLocal({...local, backgroundUrl: e.target.value})} />
                          </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // --- ä¸»ç¨‹åº: App ---
        const App = () => {
            const [auth, setAuth] = useState(sessionStorage.getItem('authenticated') === 'true');
            const [tab, setTab] = useState('domains');
            const [isDark, setIsDark] = useState(false);
            const [config, setConfig] = useState({ accountId: '', pagesToken: '', zoneToken: '', backgroundUrl: '', parentDomain: '', paths: [{label:'U1', value:'uuid'}] });

            useEffect(() => {
                if (auth) { fetch('/api/config').then(r => r.json()).then(d => d.success && d.config && setConfig(d.config)); }
            }, [auth]);

            useEffect(() => {
                document.documentElement.classList.toggle('dark', isDark);
                const bg = document.getElementById('custom-bg-layer'); if (bg) bg.remove();
                if (config.backgroundUrl) {
                    const isVid = /\.(mp4|webm|mov)(\?|$)/i.test(config.backgroundUrl);
                    const el = document.createElement(isVid ? 'video' : 'img');
                    el.id = 'custom-bg-layer'; el.src = config.backgroundUrl;
                    if (isVid) { el.autoplay = el.loop = el.muted = el.playsInline = true; }
                    document.body.appendChild(el); setTimeout(() => el.style.opacity = '1', 50);
                }
            }, [isDark, config.backgroundUrl]);

            if (!auth) return html`<${Login} onLoginSuccess=${() => setAuth(true)} />`;

            return html`
                <div class="flex h-screen w-screen overflow-hidden relative z-10 p-4 max-md:p-2">
                    <div class="w-64 max-md:hidden glass rounded-[32px] p-6 flex flex-col shadow-2xl mr-4 border-white/20">
                        <div class="flex items-center gap-3 mb-12 pl-2">
                            <img src="${APP_LOGO}" class="w-10 h-10 rounded-2xl shadow-lg object-cover" />
                            <h1 class="font-black text-lg dark:text-white tracking-tight">${APP_NAME}</h1>
                        </div>
                        <nav class="flex-1 space-y-3">
                            ${[
                              {id: 'domains', label: 'åŸŸåæ§åˆ¶', icon: 'ğŸŒ'},
                              {id: 'generator', label: 'éšæœºç”Ÿæˆ', icon: 'âœ¨'},
                              {id: 'settings', label: 'é…ç½®ä¸­å¿ƒ', icon: 'âš™ï¸'}
                            ].map(t => html`
                                <button onClick=${() => setTab(t.id)} class="w-full flex items-center gap-4 px-5 py-4 rounded-2xl transition-all duration-300 ${tab === t.id ? 'bg-blue-600 text-white shadow-xl scale-[1.03]' : 'text-slate-500 dark:text-slate-400 hover:bg-white/60 dark:hover:bg-white/10'}">
                                    <span class="text-xl">${t.icon}</span>
                                    <span class="font-bold text-sm">${t.label}</span>
                                </button>
                            `)}
                        </nav>
                        <div class="flex items-center justify-between pt-6 border-t border-slate-200 dark:border-white/10">
                          <button onClick=${() => setIsDark(!isDark)} class="p-3.5 rounded-2xl bg-slate-100 dark:bg-slate-800 text-lg hover:scale-110 active:scale-95 transition-transform">
                              ${isDark ? 'ğŸŒ™' : 'â˜€ï¸'}
                          </button>
                          <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest opacity-60">Stable Build</span>
                        </div>
                    </div>
                    <main class="flex-1 overflow-y-auto p-10 max-md:p-6 glass rounded-[32px] shadow-2xl relative border-white/20 custom-scroll">
                        ${tab === 'domains' && html`<${DomainManager} config=${config} />`}
                        ${tab === 'generator' && html`<${SubdomainGenerator} config=${config} />`}
                        ${tab === 'settings' && html`<${Settings} config=${config} setConfig=${setConfig} />`}
                    </main>
                    ${!config.backgroundUrl && html`<div class="fixed inset-0 -z-20 bg-gradient-to-br from-indigo-50 via-white to-sky-50 dark:from-slate-950 dark:via-slate-900 dark:to-slate-950"></div>`}
                </div>
            `;
        };

        render(html`<${App} />`, document.getElementById('root'));
    </script>
</body>
</html>